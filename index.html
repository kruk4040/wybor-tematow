<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wybor Tematow - Eksport XLSX</title>
<style>
  body{display:flex;flex-direction:column;align-items:center;padding:20px;background:#f7f8fb;color:#111;font-family:system-ui,sans-serif;}
  h1{text-align:center;margin:6px 0 6px}
  .panel{width:100%;max-width:980px;background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,.06);margin-bottom:18px}
  label{display:block;margin-bottom:6px;font-weight:600}
  select,input{padding:8px;border-radius:8px;border:1px solid #cbd5e1;width:100%;box-sizing:border-box}
  .memberRow{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
  button{padding:8px 12px;border-radius:8px;border:0;background:#2563eb;color:#fff;cursor:pointer}
  button.secondary{background:#64748b}
  button.danger{background:#ef4444}
  .topicBox{width:100%;max-width:960px;background:#fff;padding:12px;border-radius:10px;box-shadow:0 2px 6px rgba(2,6,23,.04);margin-bottom:10px}
  .topicHeader{display:flex;justify-content:space-between;align-items:center}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #e2e8f0;padding:8px;text-align:left}
  .timestamp{font-size:12px;color:#475569;margin-top:6px}
  .adminBar{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}
  .hidden{display:none}
  .controls{display:flex;gap:6px;margin-top:6px}
  .muted{color:#64748b;font-size:13px}
  @media (max-width:600px){ .memberRow{grid-template-columns:1fr} }

  .fullGroup { background-color:#c6f6d5!important; }
  .smallGroup { background-color:#fef08a!important; }
  .albumError {
      background:#ef4444!important;
      color:white!important;
      font-weight:bold;
  }
</style>
</head>
<body>

<h1>Lista Tematów</h1>

<div style="font-weight:bold; margin-bottom:18px; text-align:center;">
  <div style="color:#008000;">Kolor Zielony – GRUPA KOMPLETNA</div>
  <div style="color:#b59b00;">Kolor Żółty – GRUPA NIEPEŁNA</div>
</div>

<div class="panel" id="mainPanel">
  <div style="margin-bottom:8px">
    <label>Wybierz temat (1–30)</label>
    <select id="topicSelect"></select>
  </div>

  <div style="margin-bottom:8px">
    <label>Liczba członków grupy (1–6)</label>
    <select id="memberCount">
      <option value="">-- wybierz --</option>
      <option value="1">1</option><option value="2">2</option><option value="3">3</option>
      <option value="4">4</option><option value="5">5</option><option value="6">6</option>
    </select>
  </div>

  <div id="members"></div>

  <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
    <button id="sendBtn">Wyślij</button>
    <button id="clearBtn" class="secondary">Wyczyść pola</button>
  </div>
</div>

<div id="topicsContainer" style="width:100%;max-width:980px"></div>

<div class="panel" style="max-width:980px;margin-top:12px">
  <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
    <div style="flex:1;min-width:200px">
      <label>Login</label>
      <input id="loginInput" placeholder="login" />
    </div>
    <div style="flex:1;min-width:200px">
      <label>Hasło</label>
      <input id="passwordInput" type="password" placeholder="hasło" />
    </div>
    <div style="align-self:end">
      <button id="loginBtn">Zaloguj</button>
      <button id="logoutBtn" class="secondary hidden">Wyloguj</button>
    </div>
  </div>

  <div class="adminBar">
    <div id="adminStatus" class="muted">Nie zalogowano</div>
  </div>

  <button id="downloadBtn" class="secondary hidden" style="margin-top:10px">Pobierz wszystkie dane (XLSX)</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script type="module">
  // ---------------- Firebase Setup ----------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCoLC2QYoqN5IJibh2vzPDm-rgpcpCq7v4",
    authDomain: "data2137-286de.firebaseapp.com",
    databaseURL: "https://data2137-286de-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "data2137-286de",
    storageBucket: "data2137-286de.appspot.com",
    messagingSenderId: "432319656148",
    appId: "1:432319656148:web:0c613e5a56dcb59d6f8b41",
    measurementId: "G-4ZBDTPHWDL"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const FIRESTORE_DOC_PATH = { collection: "tematy30", docId: "main" };

  // ---------------- Globals ----------------
  const ADMIN_LOGIN = 'admin';
  const ADMIN_PASS = 'kutaskozla';
  let topics = Array.from({length:30}, (_,i)=>({title:`Temat ${i+1}`, records:[]}));

  const topicSelect=document.getElementById('topicSelect');
  const memberCount=document.getElementById('memberCount');
  const membersDiv=document.getElementById('members');
  const topicsContainer=document.getElementById('topicsContainer');
  const sendBtn=document.getElementById('sendBtn');
  const clearBtn=document.getElementById('clearBtn');
  const loginInput=document.getElementById('loginInput');
  const passwordInput=document.getElementById('passwordInput');
  const loginBtn=document.getElementById('loginBtn');
  const logoutBtn=document.getElementById('logoutBtn');
  const adminStatus=document.getElementById('adminStatus');
  const downloadBtn=document.getElementById('downloadBtn');
  let isAdmin=false;

  function formatDateFull(d){
    const pad=n=>String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  async function loadFromFirestore(){
    try {
      const ref = doc(db, FIRESTORE_DOC_PATH.collection, FIRESTORE_DOC_PATH.docId);
      const snap = await getDoc(ref);
      if(snap.exists()){
        const data = snap.data();
        if(data.topics && Array.isArray(data.topics)){
          for(let i=0;i<Math.min(data.topics.length, topics.length);i++){
            if(data.topics[i]){
              if(data.topics[i].records) topics[i].records = data.topics[i].records;
              if(data.topics[i].title) topics[i].title = data.topics[i].title;
            }
          }
        }
      } else console.log('No Firestore doc, using defaults');
    } catch(e){ console.error('Firestore load error', e); }
  }

  async function save(){
    try {
      const ref = doc(db, FIRESTORE_DOC_PATH.collection, FIRESTORE_DOC_PATH.docId);
      await setDoc(ref, { topics }, { merge: true });
      console.log('Saved to Firestore');
    } catch(e){ console.error('Firestore save error', e); }
  }

  function loadTopicsSelect(){ topicSelect.innerHTML = topics.map((t,i)=>`<option value="${i}">${i+1}. ${t.title}</option>`).join(''); }
  function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  function validName(n){return /^[A-Za-ząćęłńóśźżĄĆĘŁŃÓŚŹŻ ]+$/.test(n);}
  function validAlbum(a){return /^[0-9]{1,5}$/.test(a);}

  // ---------------- UI Event Listeners ----------------
  memberCount.addEventListener('change',()=>{
    const n = Number(memberCount.value);
    membersDiv.innerHTML='';
    if(!n) return;
    for(let i=1;i<=n;i++){
      const row=document.createElement('div');
      row.className='memberRow';
      row.innerHTML=`<input class="memberName" placeholder="Imię i nazwisko ${i}" />
                     <input class="memberAlbum" maxlength="5" placeholder="Numer albumu ${i}" />`;
      membersDiv.appendChild(row);
    }
  });

  sendBtn.addEventListener('click', async () => {
    const idx = Number(topicSelect.value);
    const names = [...document.querySelectorAll('.memberName')];
    const albums = [...document.querySelectorAll('.memberAlbum')];

    if(names.length===0) return alert("Wybierz liczbę członków!");
    const members=[];
    for(let i=0;i<names.length;i++){
      const n=names[i].value.trim();
      const a=albums[i].value.trim();
      if(!n || !a) return alert("Wypełnij wszystkie pola!");
      if(!validName(n)) return alert(`Imię i nazwisko ${i+1} — tylko litery i spacje`);
      if(!validAlbum(a)) return alert(`Numer albumu może mieć maksymalnie 5 cyfr`);
      members.push({name:n, album:a});
    }

    topics[idx].records.push({ members, time: formatDateFull(new Date()) });
    await save();
    renderTopics();
    membersDiv.innerHTML='';
    memberCount.value='';
  });

  // ---------------- Render Topics ----------------
  function renderTopics(){
    topicsContainer.innerHTML='';
    topics.forEach((t,topicIndex)=>{
      const box=document.createElement('div');
      box.className='topicBox';
      box.innerHTML=`<div class="topicHeader">
        <h3 style="margin:0">${t.title}</h3>
        <div class="muted">#${topicIndex+1}</div>
      </div>`;
      if(t.records.length===0){
        box.innerHTML+=`<div class="timestamp">Brak zgłoszeń</div>`;
      } else {
        t.records.forEach((rec,recIndex)=>{
          const recDiv=document.createElement('div');
          const groupSize = rec.members.length;
          const groupClass = groupSize === 6 ? "fullGroup" : "smallGroup";
          let tableHtml=`<table class="${groupClass}"><thead><tr><th>Imię i nazwisko</th><th>Album</th></tr></thead><tbody>`;
          rec.members.forEach(m=>{
            const albumClass = m.album === "00000" ? "albumError" : "";
            tableHtml+=`<tr><td>${escapeHtml(m.name)}</td><td class="${albumClass}">${escapeHtml(m.album)}</td></tr>`;
          });
          tableHtml+=`</tbody></table>`;
          recDiv.innerHTML=tableHtml;
          recDiv.innerHTML+=`<div class="timestamp">Wysłano: ${escapeHtml(rec.time)}</div>`;

          if(isAdmin){
            const ctrl=document.createElement('div');
            ctrl.className='controls';
            const editBtn=document.createElement('button'); editBtn.textContent='Edytuj';
            editBtn.addEventListener('click',()=>openEditDialog(topicIndex,recIndex));
            const delBtn=document.createElement('button'); delBtn.textContent='Usuń'; delBtn.className='danger';
            delBtn.addEventListener('click',()=>{
              if(confirm("Usunąć wpis?")){
                topics[topicIndex].records.splice(recIndex,1);
                save(); renderTopics();
              }
            });
            ctrl.appendChild(editBtn); ctrl.appendChild(delBtn); recDiv.appendChild(ctrl);
          }

          box.appendChild(recDiv);
        });
      }

      if(isAdmin){
        const editTopicBtn=document.createElement('button');
        editTopicBtn.textContent='Edytuj temat';
        editTopicBtn.style.marginTop='6px';
        editTopicBtn.addEventListener('click',()=>editTopicTitle(topicIndex));
        box.appendChild(editTopicBtn);
      }

      topicsContainer.appendChild(box);
    });
  }

  // ---------------- Admin ----------------
  function setAdminMode(on){
    isAdmin = !!on;
    if(isAdmin){
      adminStatus.textContent="Zalogowano jako admin";
      logoutBtn.classList.remove("hidden");
      loginBtn.classList.add("hidden");
      loginInput.disabled=true; passwordInput.disabled=true;
      downloadBtn.classList.remove("hidden");
    } else {
      adminStatus.textContent="Nie zalogowano";
      logoutBtn.classList.add("hidden");
      loginBtn.classList.remove("hidden");
      loginInput.disabled=false; passwordInput.disabled=false;
      downloadBtn.classList.add("hidden");
    }
    renderTopics();
  }

  loginBtn.addEventListener('click',()=>{
    const login=loginInput.value.trim();
    const pass=passwordInput.value.trim();
    if(login===ADMIN_LOGIN && pass===ADMIN_PASS){
      sessionStorage.setItem('isAdmin','1');
      setAdminMode(true);
      alert("Zalogowano jako admin");
    }else alert("Zły login lub hasło");
  });

  logoutBtn.addEventListener('click',()=>{
    sessionStorage.removeItem('isAdmin');
    loginInput.value=''; passwordInput.value='';
    setAdminMode(false);
  });

  if(sessionStorage.getItem('isAdmin')==='1') setAdminMode(true);

  // ---------------- XLSX ----------------
  function buildWorkbook(){
    const wb = XLSX.utils.book_new();
    const aoa = []; const dataRowStyles = [];
    topics.forEach((topic,tIndex)=>{
      aoa.push([`Temat ${tIndex+1}: ${topic.title}`]); dataRowStyles.push(null);
      aoa.push([]); dataRowStyles.push(null);
      aoa.push(['Imię i nazwisko','Album','Data wysłania']); dataRowStyles.push({header:true});
      topic.records.forEach(rec=>{
        const groupSize = rec.members.length;
        const rowFillColor = (groupSize===6)?"C6F6D5":"FEF08A";
        rec.members.forEach(m=>{
          aoa.push([m.name,m.album,rec.time]);
          const isAlbumError = (m.album==="00000");
          dataRowStyles.push({fill:rowFillColor,albumError:isAlbumError});
        });
      });
      aoa.push([]); dataRowStyles.push(null);
    });
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    ws['!cols'] = [{wpx:220},{wpx:110},{wpx:160}];
    let rowIndex=1;
    for(let i=0;i<dataRowStyles.length;i++){
      const styleInfo=dataRowStyles[i];
      const A=`A${rowIndex}`,B=`B${rowIndex}`,C=`C${rowIndex}`;
      if(styleInfo && styleInfo.header){[A,B,C].forEach(addr=>{if(!ws[addr]) ws[addr]={t:'s',v:''}; ws[addr].s=ws[addr].s||{}; ws[addr].s.font={bold:true}; ws[addr].s.alignment={horizontal:"center"};});}
      else if(styleInfo && styleInfo.fill){[A,B,C].forEach(addr=>{if(!ws[addr]) ws[addr]={t:'s',v:''}; ws[addr].s={fill:{patternType:"solid",fgColor:{rgb:styleInfo.fill}}};}); if(styleInfo.albumError){ws[B].s={fill:{patternType:"solid",fgColor:{rgb:"EF4444"}},font:{color:{rgb:"FFFFFF"},bold:true}};}}
      else if(ws[A] && typeof ws[A].v==='string' && ws[A].v.startsWith('Temat ')){ws[A].s={font:{bold:true,sz:12}};}
      rowIndex++;
    }
    XLSX.utils.book_append_sheet(wb,ws,'Wszystkie tematy'.substring(0,31));
    return wb;
  }
  function downloadXLSX(){const wb=buildWorkbook(); XLSX.writeFile(wb,"tematy.xlsx",{bookType:"xlsx",cellStyles:true});}
  downloadBtn.addEventListener('click',downloadXLSX);

  // ---------------- Init ----------------
  (async function init(){await loadFromFirestore(); loadTopicsSelect(); renderTopics(); if(sessionStorage.getItem('isAdmin')==='1') setAdminMode(true);})();
</script>
</body>
</html>
